
// „Åì„ÅÆÈñ¢Êï∞„ÅÆÂÜÖÂÆπ„ÇíÂ§â„Åà„Çã„Å†„Åë„ÅßËá™ÂàÜ„ÅÆ„Ç≤„Éº„É†„Å´‰Ωø„Åà„Åæ„ÅôÔºÅ
// Ëâ≤„ÄÖ„Å™„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂ§â„Åà„Å¶„Åè„Å†„Åï„ÅÑ
const set_options = () => {
  // „Éñ„É≠„ÉÉ„ÇØ„Å™„Å©„ÇíË°®„Åô„Çø„Ç§„É´„ÅØ32„Éî„ÇØ„Çª„É´„Å®„ÅÑ„ÅÜ„Çµ„Ç§„Ç∫„ÅÆrect„ÅßË°®„Åó„Å¶„ÅÑ„Åæ„Åô
  const tile_size = 32;

  // tiles„Å´Ëâ≤„ÅÆÊñáÂ≠óÂàó„ÅãÁµµÊñáÂ≠ó„Çí‰Ωø„ÅÜ„Åì„Å®„Åå„Åß„Åç„Åæ„Åô
  // tilesÈÖçÂàó„Å®„Çø„Ç§„É´‰∏Ä„Å§„ÇíÊèè„ÅèÈñ¢Êï∞tile_draw_function„ÇíÊñ∞„Åó„Åè‰Ωú„Çã„Åì„Å®„Åß
  // Êñ∞„Åó„ÅÑ„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ„É¢„Éº„Éâ„Çí‰Ωú„Çã„ÅÆ„ÇÇÂèØËÉΩ

  // Ëâ≤„ÅØÂÆüÈöõ„ÅÆ„Éï„Ç°„Éü„Ç≥„É≥„ÅÆËâ≤„Çí‰Ωø„ÅÑ„Åæ„Åó„Åü: http://www.firebrandx.com/nespalette.html
  // ÂÆöÊï∞Êâ±„ÅÑ
  const sample_color_tiles = [
    "#c3f6f6", // 0 Á©∫Ëâ≤
    "#754702", // 1 Ëå∂Ëâ≤
    "#b3af0d", // 2 ÈªÑËâ≤
    "#027645", // 3 Á∑ë
    "#983700", // 4 Ëµ§
    "#071380", // 5 Èùí
    "#7bc213", // 6 ÈªÑÁ∑ë
  ];
  const sample_emoji_tiles = [
    " ",
    "üì¶",
    "üéÅ",
    "üìó",
    "üë®‚Äçüîß",
    "üí¶",
    "üê¢",
  ];

  // ‰∏Ä„Å§‰∏Ä„Å§„ÅÆ„Çø„Ç§„É´„ÇíÊèè„ÅèÈñ¢Êï∞„ÄÇ
  // ÂõõËßí„Éê„Éº„Ç∏„Éß„É≥
  const drawSquare = (i, j, tile='#000000', size=32) => {
    fill(tile);
    rect(j * size, i * size, size, size);
  };
  // ÁµµÊñáÂ≠ó„Éê„Éº„Ç∏„Éß„É≥
  const drawEmoji = (i, j, tile='‚õ∞', size=32) => {
    textSize(size);
    text(tile, j * size, i * size, size, size);
  };

  // „Åì„ÅÆ‰∏ã„ÅÆ`tile_engine`„ÅØ‰∏Ä„Å§„Å†„ÅëÂÆöÁæ©„Åß„Åç„Åæ„Åô
  // ÂõõËßí„ÅãÁµµÊñáÂ≠ó„Çí„Åà„Çâ„Çì„Åß„ÄÅ‰ªñ„ÅØ„Ç≥„É°„É≥„Éà„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ

  // „Çø„Ç§„É´„Å´ÂçòËâ≤„ÅÆÂõõËßí„Çí‰Ωø„ÅÜÂ†¥Âêà
  // const tile_engine = {
  //   tiles: sample_color_tiles,
  //   tile_draw_function: drawSquare
  // };
  // „Çø„Ç§„É´„Å´ÁµµÊñáÂ≠ó„Çí‰Ωø„ÅÜÂ†¥Âêà
  const tile_engine = {
    tiles: sample_emoji_tiles,
    tile_draw_function: drawEmoji
  };

  // ÂêÑ„Çπ„ÉÜ„Éº„Ç∏ÔºàÈù¢Ôºâ„ÅÆ„Éû„ÉÉ„Éó„ÄÇÊï∞Â≠ó„ÅØÂá∫„Åó„Åü„ÅÑËâ≤„ÅÆ tiles „Åß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
  // ÂÆöÊï∞Êâ±„ÅÑ
  const stages = [
    [
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 1, 0],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    [
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    [
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 0, 0],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 1, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    [
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 1, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
    ],
    [
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 1, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    [
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 1, 0, 2, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
    ],
    [
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 2, 2, 0, 0, 0, 1, 0, 0, 0],
      [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    ],
    [
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    ],
    [
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, 1],
      [0, 1, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 1, 0, 1, 1, 1],
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    ],
  ];

  // ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ‰ΩçÁΩÆÈñ¢‰øÇ„ÇíË°®„Åô„Éû„ÉÉ„Éó
  // Êï∞Â≠ó„ÅØ`stages`„ÅÆ‰∏≠„ÅÆÂêÑ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
  // `stages[0]`„ÅØÊúÄÂàù„Å´Âá∫„Å¶„Åè„Çã„Çπ„ÉÜ„Éº„Ç∏„Å®„Åï„Çå„Åæ„Åô
  const scroll_map = [
    [1, 2, 3],
    [4, 0, 5],
    [6, 7, 8],
  ];

  // „Åì„ÅÆ‰∏ä„ÅÆË®≠ÂÆö„Åß„ÄÅ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂàùÊúüÂåñÔºÅ
  screen = new ScreenScroller(tile_engine.tile_draw_function, scroll_map, tile_size, tile_engine.tiles, stages);
};


// „Ç≤„Éº„É†„ÅÆËÉåÊôØ„ÇíÁÆ°ÁêÜ„Åô„Çã„ÇØ„É©„Çπ
// „Åì„Åì„Çà„Çä‰∏ã„ÅÆ„Ç≥„Éº„Éâ„ÇíÁ∑®ÈõÜ„Åó„Å™„Åè„Å¶„ÇÇ„ÅÑ„Çç„ÅÑ„Çç„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åå„Åß„Åç„Åæ„Åô
class ScreenScroller {
  constructor(tile_draw_function, scroll_map = [0, 1], tile_size=32, tiles=[], stages=[]) {
    this.tile_draw_function = tile_draw_function;
    this.scroll_map = scroll_map;
    this.tile_size = tile_size;
    this.tiles = tiles;
    this.stages = stages;

    // „Çπ„ÇØ„É≠„Éº„É´„Åå„Åæ„Å†Âßã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑÊôÇ„ÅØnull„ÄÅÈÄî‰∏≠„ÅÆÊôÇ„ÅØÁµåÈÅé„Çø„Ç§„É´Êï∞
    this.scroll_progress = null;
    // „Çπ„ÇØ„É≠„Éº„É´ÂÖÉ„ÅØthis.stages„ÅÆ‰∏≠„ÅÆindex„Åß„Åô„ÄÇÊúÄÂàù„ÅØ„Éá„Éï„Ç©„É´„Éà0„Åß„Åô
    this.current_stage = 0;
    // „Çπ„ÇØ„É≠„Éº„É´ÂÖà„ÅØthis.stages„ÅÆ‰∏≠„ÅÆindex„Åß„Åô„ÄÇÊú™ÂÆö„ÅÆÊôÇ„ÅØnull
    this.scroll_to = null;
    this.direction = null;

    // Ë°å„ÅÆÊï∞Ôºà„Çø„Ç§„É´Âçò‰ΩçÔºâ
    this.rows = this.stages[0].length;
    // Âàó„ÅÆÊï∞Ôºà„Çø„Ç§„É´Âçò‰ΩçÔºâ
    this.cols = this.stages[0][0].length;

    // Êú¨ÂΩì„Å´Ë°®Á§∫„Åï„Çå„ÇãÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó
    // this.stages„Å®ÈÅï„Å£„Å¶„ÄÅ‰∏≠Ë∫´„Åå„Çπ„ÇØ„É´„Éº„É´„Åó„Å¶„ÅÑ„Çã„Å®Â§â„Çè„Çä„Åæ„Åô
    this.screen = this.stages[this.current_stage].slice(0);
  }

  // „Çπ„Ç±„ÉÉ„ÉÅ„ÅÆdrawÈñ¢Êï∞„ÅßÂëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞
  // „Çπ„ÇØ„É≠„Éº„É´„ÅÆÊµÅ„Çå„ÇíÂà∂Âæ°„Åô„Çã
  draw() {
    // „ÇÇ„Åó‰ªä„Çπ„ÇØ„É≠„Éº„É´„ÅåÂßã„Åæ„Çç„ÅÜ„Å®„Åó„Å¶„ÅÑ„Çã„Å™„Çâ
    if (screen.scroll_progress === 1) {
      // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÅÆÂè≥„Å´Ë°å„ÅçÂÖà„ÅÆ„Éû„ÉÉ„Éó„Çí„Åè„Å£„Å§„Åë„Åæ„Åó„Çá„ÅÜ
      screen.generate_matrix_with_two_screens();
    }
    // „Çπ„ÇØ„É≠„Éº„É´‰∏≠„ÅÆÂ†¥Âêà
    if (screen.scroll_progress !== null){
      // „Çπ„ÇØ„É≠„Éº„É´„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Å™„Çâ
      if (screen.scroll_progress > screen.cols) {
        // „Çπ„ÇØ„É≠„Éº„É´„ÅÆÂæåÂá¶ÁêÜ„ÇíË°å„ÅÜ
        screen.finalize_scroll();
      } else {
        // „Çπ„ÇØ„É≠„Éº„É´„ÇíÈÄ≤„Åæ„Åõ„Çã
        screen.advance_scroll();
      }
    }
    // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÇíË°®Á§∫„Åï„Åõ„Çã
    screen.display_map();
  }

  // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÇíË°®Á§∫„Åï„Åõ„Çã
  display_map() {
    if (this.scroll_progress === null) {
      this.screen = this.stages[this.current_stage].slice(0);
    }
    // Â∑¶„Å®‰∏ä„Å´ÁßªÂãï„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÈÄ≤„ÇÄ„ÅÆ„Åß„ÅØ„Å™„Åè„Å¶Êàª„Çã„ÅÆ„ÅßÂá¶ÁêÜ„ÅåÂ§öÂ∞ëË§áÈõë„Å´„Å™„Çä„Åæ„Åô
    if (this.direction === 'left') {
      const screencols = this.screen[0].length;
      let offset = screencols - this.cols - this.scroll_progress;
      offset = offset >= 0? offset : 0;
      for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < screencols; j++) {
          this.tile_draw_function(i, j - offset, this.tiles[this.screen[i][j]], this.tile_size)
        }
      }
    } else if (this.direction === 'up') {
      const screenrows = this.screen.length;
      let offset = screenrows - this.rows - this.scroll_progress;
      offset = offset >= 0? offset : 0;
      for (var i = 0; i < screenrows; i++) {
        for (var j = 0; j < this.cols; j++) {
          this.tile_draw_function(i - offset, j, this.tiles[this.screen[i][j]], this.tile_size)
        }
      }
    } else {
      for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.cols; j++) {
          this.tile_draw_function(i, j, this.tiles[this.screen[i][j]], this.tile_size)
        }
      }
    }
  }

  // ÁèæÂú®„ÅÑ„Çã„Çπ„ÉÜ„Éº„Ç∏„ÅÆ`this.scroll_map`„ÅÆ‰∏≠„Åß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíËøî„Åô
  // `this.scroll_map`„ÅØ‰∫åÊ¨°ÈÖçÂàó„Å™„ÅÆ„Åß„ÄÅ[x, y]„ÅÆÂΩ¢„ÅßËøî„Åô
  get_stage_indices(stage = 0) {
    // `this.scroll_map`„Çí1Ê¨°ÂÖÉ„Å´„Åó„Å¶ÁèæÂú®‰ΩçÁΩÆ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË™ø„Åπ„Çã
    const index = [].concat.apply([], ([].concat.apply([], this.scroll_map))).indexOf(stage);
    if (index === -1) {
      return false;
    }
    // ‰Ωï„Ç≥„É©„É†„ÅÇ„Çã„Åã
    const numColumns = this.scroll_map[0].length;
    // 1Ê¨°ÂÖÉ„Åß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„Çâ‰ΩïË°åÁõÆ„ÅãË®àÁÆó
    const row = parseInt(index / numColumns);
    // 1Ê¨°ÂÖÉ„Åß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„Çâ‰ΩïÂàóÁõÆ„ÅãË®àÁÆó
    const col = index % numColumns;
    return [col, row]; 
  }

  // `this.scroll_map`„Å´„Åù„Å£„Å¶Ë°åÂÖà„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÇíË™ø„Åπ„Çã
  // Ë°å„ÅçÊ≠¢„Åæ„Çä„ÅÆÂ†¥Âêà„ÅØ`false`„ÇíËøî„Åô
  get_destination() {
    const current_stage_indices = this.get_stage_indices(this.current_stage);
    // console.log('ÁèæÂú®‰ΩçÁΩÆ', current_stage_indices);
    // „Å≤„Å®„Åæ„Åö„ÄÅ„Çè„Åã„Çä„ÇÑ„Åô„ÅÑ„Ç¢„Ç¶„Éà„ÇíËπ¥„Çã
    if (this.direction == 'left' && current_stage_indices[0] < 1) {
      return false;
    }
    if (this.direction == 'up' && current_stage_indices[1] < 1) {
      return false;
    }

    // ÁõÆÁöÑÂú∞„ÅÆ`this.scroll_map`„ÅÆ‰∏≠„ÅÆ[x, y]„ÇíÊ±∫„ÇÅ„Çã
    let destination_stage_indices = current_stage_indices;
    if (this.direction == 'left') {
      destination_stage_indices[0] = destination_stage_indices[0] - 1;
    }
    else if (this.direction == 'right') {
      destination_stage_indices[0] = destination_stage_indices[0] + 1;
    }
    else if (this.direction == 'up') {
      destination_stage_indices[1] = destination_stage_indices[1] - 1;
    }
    else if (this.direction == 'down') {
      destination_stage_indices[1] = destination_stage_indices[1] + 1;
    }

    // console.log('ÁõÆÁöÑÂú∞', destination_stage_indices);

    // Âè≥„ÇÑ‰∏ã„Åã„Çâ„ÅØ„ÅøÂá∫„ÅüÂ†¥Âêà„ÇÇ„ÄÅËπ¥„Çã
    if (
      destination_stage_indices[1] >= this.scroll_map.length
      || destination_stage_indices[0] >= this.scroll_map[0].length 
    ) {
      return false;
    }
    const destination = this.scroll_map[destination_stage_indices[1]][destination_stage_indices[0]];
    return destination;
  }

  // „Çπ„ÇØ„É≠„Éº„É´„ÅåÊôÇÂßã„Åæ„Çã„Çà„ÅÜ„Å´Ë®≠ÂÆö„Åô„Çã
  // „Åì„ÅÆ„Çπ„Ç±„ÉÉ„ÉÅ„Åß„ÅØ„Éû„Ç¶„Çπ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßË™òÁô∫„Åô„Çã„Åå„ÄÅ„Åç„Å£„Åã„Åë„ÅØ„Å™„Çì„Åß„ÇÇ„ÅÑ„ÅÑ
  initiate_scroll(direction = 'right') {
    if (screen.scroll_progress === null) {
      this.direction = direction;
      const destination = this.get_destination(this.direction);
      // console.log(direction, destination)
      if (destination === false) {
        return;
      }
      this.scroll_to = destination;
      this.scroll_progress = 1;
    }
  }

  // 2Èù¢„ÅÆÂπÖ„ÇíÊåÅ„Å§„Éû„ÉÉ„Éó„ÇíÁîüÊàê„Åô„Çã
  generate_matrix_with_two_screens() {
    if (this.direction === 'right') {
      // ÁîªÈù¢„ÅÆÂêÑË°å
      for (var i = 0; i < this.rows; i++) {
        // ‰ªä„Åæ„Åß„ÅÑ„ÅüÈù¢„ÅÆ„Åù„ÅÆË°å„Å®Âêå„Åò„Å´„Å™„Çã
        this.screen[i] = this.stages[this.current_stage][i].slice(0);
        // „Åù„Åó„Å¶„ÄÅ‰ªä„Åã„Çâ„ÅÑ„ÅèÈù¢„ÅÆ„Åì„ÅÆË°å„ÅÆË¶ÅÁ¥†ÔºàÊï∞Â≠óÔºâ„Çí‰∏Ä„Å§„Åö„Å§Âæå„Çç„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åè
        for (var j = 0; j < this.cols; j++) {
          this.screen[i].push(this.stages[this.scroll_to][i][j]);
        }
      }
    } else if (this.direction === 'left') {
      // ÁîªÈù¢„ÅÆÂêÑË°å
      for (var i = 0; i < this.rows; i++) {
        // ‰ªä„Åæ„Åß„ÅÑ„ÅüÈù¢„ÅÆ„Åù„ÅÆË°å„Å®Âêå„Åò„Å´„Å™„Çã
        this.screen[i] = this.stages[this.scroll_to][i].slice(0);
        // „Åù„Åó„Å¶„ÄÅ‰ªä„Åã„Çâ„ÅÑ„ÅèÈù¢„ÅÆ„Åì„ÅÆË°å„ÅÆË¶ÅÁ¥†ÔºàÊï∞Â≠óÔºâ„Çí‰∏Ä„Å§„Åö„Å§Âæå„Çç„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åè
        for (var j = 0; j < this.cols; j++) {
          this.screen[i].push(this.stages[this.current_stage][i][j]);
        }
      }
    } else if (this.direction === 'down') {
      // ÁèæÂú®‰ΩçÁΩÆ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ‰∏ã„Å´Ë°åÂÖà„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Çí„Åè„Å£„Å§„Åë„Åæ„Åô
      this.screen = this.stages[this.current_stage].slice(0);
      for (var i = 0; i < this.rows; i++) {
        this.screen.push(this.stages[this.scroll_to][i].slice(0));
      }
    } else if (this.direction === 'up') {
      // Ë°åÂÖà„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ‰∏ã„Å´ÁèæÂú®‰ΩçÁΩÆ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Çí„Åè„Å£„Å§„Åë„Åæ„Åô
      this.screen = this.stages[this.scroll_to].slice(0);
      for (var i = 0; i < this.rows; i++) {
        this.screen.push(this.stages[this.current_stage][i].slice(0));
      }
    }
    // console.log(this.direction);
    // this.log_screen();
  }
  // ‰ªä„ÅÆÁîªÈù¢„ÇíÊñáÂ≠ó„Åß`console`„Å´Âá∫Âäõ„Åó„Åæ„Åô
  log_screen() {
    this.screen.forEach((e) => {
      let row = '';
      e.forEach((c) => {
        row += c;
      });
      console.log(row);
    });
  }
  // Ê¨°„ÅÆÈù¢„Åæ„Åß1„Çø„Ç§„É´„Åö„Å§„Çπ„ÇØ„É≠„Éº„É´„Åï„Åõ„Åæ„Åô
  advance_scroll() {
    if (this.direction === 'right') {
      // ÁîªÈù¢„ÅÆÂêÑË°å
      for (var i = 0; i < this.rows; i++) {
        // „Åù„ÅÆË°å„ÅÆÊúÄÂàùÔºà‰∏ÄÁï™Â∑¶„ÅÆÔºâ„Çø„Ç§„É´„ÇíÂèñ„ÇäÈô§„Åè
        this.screen[i].shift();
      }
    } else if (this.direction === 'down') {
      // ‰∏äÈáéË°å„ÇíÊäú„Åç„Åæ„Åô„ÄÇ„Åó„Åã„Åó„ÄÅÊäú„Åç„Åô„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´`if`
      if (this.screen.length > this.rows) {
        this.screen.shift();
      }
    } else if (this.direction === 'left') {
      // ÁîªÈù¢„ÅÆÂêÑË°å
      for (var i = 0; i < this.rows; i++) {
        // „Åù„ÅÆË°å„ÅÆÊúÄÂæåÔºà‰∏ÄÁï™Âè≥„ÅÆÔºâ„Çø„Ç§„É´„ÇíÂèñ„ÇäÈô§„Åè
        // this.screen[i].pop();
      }
    } else if (this.direction === 'up') {
      if (this.screen.length > this.rows) {
        // this.screen.shift();
      }
    }
    // 1„Çø„Ç§„É´ÂàÜ„Çπ„ÇØ„É≠„Éº„É´„ÅåÈÄ≤„Çì„Å†„Å®Ë®òÈå≤„Åô„Çã
    this.scroll_progress ++;
  }

  finalize_scroll() {
    // „Åó„Å∞„Çâ„Åè„Çπ„ÇØ„É≠„Éº„É´„ÇíÊ≠¢„ÇÅ„Çã„Çà„ÅÜ„Å´
    this.scroll_progress = null;
    // ‰ªä„Åæ„Åß„ÅÆË°å„ÅçÂÖà„ÅåÊ¨°„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÅÆÂéüÁÇπ„Å®„Å™„Çã
    this.current_stage = this.scroll_to;
    // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„Çí„Åù„ÅÆ„Åæ„ÅæË°å„ÅçÂÖà„ÅÆÈù¢„Å®Âêå„Åò„Å´„Åô„Çã
    this.screen = this.stages[this.current_stage].slice(0);

    // Ê¨°„ÅÆË°åÂÖà„ÅØÊú™ÂÆö
    this.scroll_to = null;
    this.direction = null;
  }
}


// ÂÆöÁæ©„Åó„Åü„ÇØ„É©„Çπ„Åã„Çâ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂêç‰ªò„Åë„Åæ„Åô
var screen;

function setup() {
  // „Çπ„ÇØ„É≠„Éº„É´„ÇíË®≠ÂÆö„Åó„Å¶ÂàùÊúüÂåñ„Åô„Çã
  // Ë®≠ÂÆö„ÅØset_options.js„ÅßÊåáÂÆö„Åó„Åæ„Åó„Çá„ÅÜ
  set_options();

  createCanvas(16*screen.tile_size, 14*screen.tile_size).parent("p5js_div");

  noStroke();
}

function draw() {
  background('#c3f6f6');

  screen.draw();
}

// „Ç≠„Éº„Éú„Éº„Éâ„ÅÆ„Ç´„Éº„ÇΩ„É´„Ç≠„Éº„Åß„Çπ„ÇØ„É≠„Éº„É´„Çí„ÅØ„Åò„ÇÅ„Åæ„Åô
function keyPressed() {
  if (keyCode == UP_ARROW) {
    screen.initiate_scroll('up');
  }
  else if (keyCode == DOWN_ARROW) {
    screen.initiate_scroll('down');
  }
  else if (keyCode == LEFT_ARROW) {
    screen.initiate_scroll('left');
  }
  else if (keyCode == RIGHT_ARROW) {
    screen.initiate_scroll('right');
  }
}
// „Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Åç„Å£„Åã„Åë„ÅØ„Ç≤„Éº„É†„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ‰ΩçÁΩÆ„Å™„Å©„Å´„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ
